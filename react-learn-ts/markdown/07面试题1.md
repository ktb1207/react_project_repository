### react 部分面试题

> 1. react 生命周期执行流程

- this.setState：触发状态变化
- render 阶段(reconcile/diff 算法)：计算出状态变化
- commit 阶段(ReactDom)： 将状态变化渲染在视图

render 阶段执行生命周期钩子如下：

- `挂载`：
  - constructor
  - getDerivedStateFromProps
  - componentWillMount(已废弃)
  - render
- `更新`：
  - componentWillReceiveProps（已废弃）
  - getDerivedStateFromProps
  - shouldComponentUpdate
  - componentWillUpdated(已废弃)
  - render
- `错误`
  - getDerivedStateFromError

commit 阶段执行生命周期钩子如下：

- `挂载`：
  - componentDidMount
- `更新`：
  - getSnapshotBeforeUpdate
  - componentDidUpdate
- `卸载`：
  - componentWillUnmount
- `错误`：
  - componentDidCatch

`总结`： render 函数调用执行，之后进入 commit 阶段

> 2. fiber 树创建流程

以以下 dom 结构列举说明

```html
<app>
  <p1>
    <c1></c1>
    <c2></c2>
  </p1>
  <p2></p2>
</app>
```

- 调用 ReactDom.render,进入 render 阶段
- 在 render 阶段，采用`深度优先遍历`创建 filber 树（vdom）
  - 创建 app,调用 app 生命周期 constructor,getDerivedStateFromProps,render,然后查找 app 是否含有子节点
  - 创建子节点 p1,并调用同上 3 个生命周期函数，然后查找 p1 是否含有子节点
    - 创建 c1,并调用同上 3 个生命周期函数，然后查找 p1 是否含有子节点, 没有子节点，则查找是否存在兄弟节点
    - 创建 c2,并调用同上 3 个生命周期函数，然后查找 c2 是否含有子节点，没有子节点，查找是否存在兄弟节点，不存在兄弟节点，则回到 p1
  - p1 子节点创建完成，查找是否存在子节点，存在子节点 p2
  - 创建子节点 p2，并调用同上 3 个生命周期函数，判断 p2 是否存在子节点，是否存在兄弟节点
  - p2 创建完毕，返回 app 根节点
  - 至此，render 阶段执行完毕，进入 commit 阶段，fileber 树渲染到视图中
- commit 阶段，将 filber 树渲染到视图中，同样采用`深度优先`从最深子节点开始执行渲染，并执行 commit 阶段生命周期钩子函数
  - c1
  - c2
  - p1
  - p2
  - app

> 3. 更新 filber 树

举例：c2 调用 setState 发生状态变化

- this.setState 发生状态变化
- 进入 render 阶段，采用`深度优先遍历`,创建一颗完整的 filber 树，创建流程同上
  - app,p1,c1 状态没有发生变化，创建 fileber 过程不会调用更新阶段对应生命周期钩子函数
  - 经过 diff 算法，发现 c2 状态发生变化，调用 c2render 阶段对应生命周期钩子函数，并标记变化
- commit 阶段
  - 执行 c2 变化对应的视图更新，执行 c2-commit 更新阶段对应的生命周期钩子函数
- 更新阶段完成，新创建的 filber 树被保存下来替换上一次的 filber 树，等待下一次更新阶段

`记住`：每次调用 setState 都会以根节点开始创建一颗完整的 filber 树
